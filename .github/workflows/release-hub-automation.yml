name: ğŸš€ Release Hub Automation

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  release-hub:
    # Only run if PR was merged and has 'release' label
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release')
    
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸ” Extract PR Information
        id: pr_info
        run: |
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "PR_BODY=${{ github.event.pull_request.body }}" >> $GITHUB_OUTPUT
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "PR_AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "PR_URL=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT
          echo "MERGED_AT=${{ github.event.pull_request.merged_at }}" >> $GITHUB_OUTPUT
      
      - name: ğŸ“ Get Commit Messages
        id: commits
        run: |
          COMMITS=$(gh pr view ${{ github.event.pull_request.number }} --json commits --jq '.commits[].messageHeadline' | jq -Rs .)
          echo "COMMIT_MESSAGES=$COMMITS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”” Slack - Release Started Notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: 'C09KC84AYU8'
          slack-message: |
            ğŸš€ *[${{ steps.pr_info.outputs.PR_TITLE }}] ë¦´ë¦¬ì¦ˆê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.*
            
            â€¢ PR #${{ steps.pr_info.outputs.PR_NUMBER }}
            â€¢ ì‘ì„±ì: ${{ steps.pr_info.outputs.PR_AUTHOR }}
            â€¢ URL: ${{ steps.pr_info.outputs.PR_URL }}
            â€¢ ë¨¸ì§€ ì‹œê°„: ${{ steps.pr_info.outputs.MERGED_AT }}
            
            _Notion ë¦´ë¦¬ì¦ˆ í—ˆë¸Œì— ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤..._
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        continue-on-error: true
      
      - name: ğŸ¤– Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm install @notionhq/client axios
      
      - name: ğŸ§  AI Content Generation & Notion Update
        run: node .github/scripts/release-hub-processor.js
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_RELEASE_DB_ID: ${{ secrets.NOTION_RELEASE_DB_ID }}
          NOTION_MARKETING_DB_ID: ${{ secrets.NOTION_MARKETING_DB_ID }}
          NOTION_CS_DB_ID: ${{ secrets.NOTION_CS_DB_ID }}
          NOTION_SALES_DB_ID: ${{ secrets.NOTION_SALES_DB_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PR_TITLE: ${{ steps.pr_info.outputs.PR_TITLE }}
          PR_BODY: ${{ steps.pr_info.outputs.PR_BODY }}
          PR_NUMBER: ${{ steps.pr_info.outputs.PR_NUMBER }}
          PR_AUTHOR: ${{ steps.pr_info.outputs.PR_AUTHOR }}
          PR_URL: ${{ steps.pr_info.outputs.PR_URL }}
          COMMIT_MESSAGES: ${{ steps.commits.outputs.COMMIT_MESSAGES }}
      
      - name: ğŸ”” Slack - Marketing Team Notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: 'C09JBHZLGNP'
          slack-message: |
            ğŸ“¢ *ìƒˆë¡œìš´ ë¦´ë¦¬ì¦ˆ ì½˜í…ì¸ ê°€ Notionì— ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!*
            
            ë¦´ë¦¬ì¦ˆ: ${{ steps.pr_info.outputs.PR_TITLE }}
            ğŸ‘‰ [ë§ˆì¼€íŒ… ì½˜í…ì¸  í™•ì¸í•˜ê¸°](https://www.notion.so/281b5b2239728171a1ead980dd3affd3)
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        continue-on-error: true
      
      - name: ğŸ”” Slack - CS Team Notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: 'C09J2LQMDL7'
          slack-message: |
            ğŸ“ *ìƒˆë¡œìš´ ë¦´ë¦¬ì¦ˆ CS ê°€ì´ë“œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!*
            
            ë¦´ë¦¬ì¦ˆ: ${{ steps.pr_info.outputs.PR_TITLE }}
            ğŸ‘‰ [CS ê°€ì´ë“œ í™•ì¸í•˜ê¸°](https://www.notion.so/281b5b22397281ddba9affe7d1fe4bd0)
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        continue-on-error: true
